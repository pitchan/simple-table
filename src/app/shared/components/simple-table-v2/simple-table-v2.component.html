<div class="simple-table-v2-container" 
     [class.loading]="loading()"
     [class.p-datatable-resizable]="resizableColumnsEnabled"
     [class.p-datatable-resizable-fit]="resizableColumnsEnabled && columnResizeMode === 'fit'"
     [class.p-datatable-resizable-expand]="resizableColumnsEnabled && columnResizeMode === 'expand'">
  
  <!-- Debug Info -->
  <div *ngIf="debug" style="background: #f0f0f0; padding: 10px; margin-bottom: 10px;">
    <strong>Debug Info:</strong><br>
    Rows in tableData: {{ tableData().length }}<br>
    Total Count: {{ totalCount() }}<br>
    Displayed Columns: {{ displayedColumns.join(', ') }}<br>
    Is Loading: {{ loading() }}<br>
    Data Source Type: {{ data ? data.constructor.name : 'undefined' }}<br>
    Resize Mode: {{ columnResizeMode }}<br>
    Is Resizing: {{ isResizing }}<br>
  </div>

  <!-- Resize Helper Indicator (PrimeNG-style vertical line during resize) -->
  <div #resizeHelper class="p-datatable-column-resize-helper" style="display: none;"></div>

  <!-- Hidden MatSort for strategies (attachSort / sort.sortChange) when using grid header click -->
  <div class="grid-sort-anchor" matSort>
    <button type="button" mat-sort-header="dummy" style="display: none;"></button>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading()">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Single grid (div-based): one wrapper, one header, body with ngIf on virtual scroll only -->
  <div class="table-wrapper" 
       [class.table-wrapper--virtual]="config.features?.virtualScroll" 
       [class.sticky-header]="config.stickyHeader">
    <div #gridTableElement 
         class="grid-table" 
         [class.p-datatable-resizing]="isResizing" 
         role="grid" 
         [attr.aria-label]="config.id || 'Table'">
      <!-- Header row (unique) -->
      <div class="grid-header-row" 
           [style.display]="'grid'"
           [style.grid-template-columns]="gridTemplateColumns()">
        <ng-container *ngIf="selection && config.features?.selection !== false">
          <div class="grid-header-cell grid-header-cell--select" role="columnheader">
            <mat-checkbox
              *ngIf="isMultipleSelection"
              (change)="$event ? masterToggle() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
          </div>
        </ng-container>
        <div *ngFor="let column of visibleColumns; trackBy: trackByColumnId; let colIndex = index"
             class="grid-header-cell"
             role="columnheader"
             [attr.data-column]="column.id"
             [class.sticky-column]="column.sticky === true || column.sticky === 'start'"
             [style.left]="(column.sticky === true || column.sticky === 'start') ? getColLeftStyle(column.id) : null"
             [class.p-resizable-column]="resizableColumnsEnabled && column.resizable !== false && !(colIndex === visibleColumns.length - 1 && columnResizeMode === 'fit')"
             pResizableColumn
             [pResizableColumnDisabled]="!resizableColumnsEnabled || column.resizable === false || (colIndex === visibleColumns.length - 1 && columnResizeMode === 'fit')"
             (resizeBegin)="onColumnResizeBegin($event)"
             (resizeEnd)="onColumnResizeEnd($event)"
             (click)="config.features?.sort !== false && column.sortable !== false && !isResizing ? onVirtualSortHeaderClick(column.id) : null">
          <span class="header-label">{{ getColumnHeader(column) }}</span>
        </div>
        <ng-container *ngIf="showConfigEditor">
          <div class="grid-header-cell grid-header-cell--config" role="columnheader">
            <button 
              mat-icon-button 
              [matMenuTriggerFor]="configMenu"
              matTooltip="{{ 'COMMON.CONFIGURE_COLUMNS' | translate }}">
              <mat-icon>more_vert</mat-icon>
            </button>
          </div>
        </ng-container>
      </div>

      <!-- Body: virtual scroll -->
      <cdk-virtual-scroll-viewport 
        *ngIf="config.features?.virtualScroll" 
        [itemSize]="virtualScrollItemSize" 
        class="grid-viewport">
        <div *cdkVirtualFor="let row of tableData(); trackBy: trackByRow"
             [ngTemplateOutlet]="rowTpl"
             [ngTemplateOutletContext]="{$implicit: row}"></div>
      </cdk-virtual-scroll-viewport>

      <!-- Body: sans virtual scroll (liste simple) -->
      <div *ngIf="!config.features?.virtualScroll" class="grid-body">
        <ng-container *ngFor="let row of tableData(); trackBy: trackByRow"
                     [ngTemplateOutlet]="rowTpl"
                     [ngTemplateOutletContext]="{$implicit: row}"></ng-container>
      </div>

      <!-- Template de ligne partagé (une seule définition des cellules) -->
      <ng-template #rowTpl let-row>
    <div class="grid-row table-row"
         [class.clickable]="rowClick.observed"
         (click)="onRowClick(row)"
         [style.display]="'grid'"
         [style.grid-template-columns]="gridTemplateColumns()"
         role="row">
      <ng-container *ngIf="selection && config.features?.selection !== false">
        <div class="grid-cell grid-cell--select" role="gridcell">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? toggleSelection(row) : null"
            [checked]="selection.isSelected(row)">
          </mat-checkbox>
        </div>
      </ng-container>
      <div *ngFor="let column of visibleColumns; trackBy: trackByColumnId"
           class="grid-cell cell-content-wrapper"
           role="gridcell"
           [class.sticky-column]="column.sticky === true || column.sticky === 'start'"
           [style.left]="(column.sticky === true || column.sticky === 'start') ? getColLeftStyle(column.id) : null"
           [matTooltip]="column.tooltip ? getCellValue(row, column) : ''"
           [matTooltipDisabled]="!column.tooltip">
        <ng-container *ngIf="!column.type || column.type === 'text' || column.type === 'date' || column.type === 'number' || column.type === 'badge'">
          <span class="cell-content" [class.clamp]="column.clamp != null" [style.--clamp-value]="column.clamp" [class.badge]="column.type === 'badge'">{{ getCellValue(row, column) }}</span>
        </ng-container>
        <ng-container *ngIf="column.type === 'link'">
          <a href="javascript:void(0)" class="cell-link" [class.clamp]="column.clamp != null" [style.--clamp-value]="column.clamp" (click)="onHyperlinkClick($event, row, column.id)">{{ getCellValue(row, column) }}</a>
        </ng-container>
        <ng-container *ngIf="column.type === 'icon'">
          <mat-icon *ngIf="getCellValue(row, column) === true">check</mat-icon>
          <mat-icon *ngIf="getCellValue(row, column) === false">close</mat-icon>
          <span *ngIf="getCellValue(row, column) !== true && getCellValue(row, column) !== false" class="cell-content">{{ getCellValue(row, column) }}</span>
        </ng-container>
        <ng-container *ngIf="column.type === 'button' && column.actions">
          <button *ngFor="let action of column.actions" mat-icon-button [matTooltip]="action.label || ''" (click)="onHyperlinkClick($event, row, action.handlerId)">
            <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
            <span *ngIf="!action.icon">{{ action.label }}</span>
          </button>
        </ng-container>
      </div>
      <ng-container *ngIf="showConfigEditor">
        <div class="grid-cell grid-cell--config" role="gridcell"></div>
      </ng-container>
    </div>
      </ng-template>
    </div>
  </div>

  <!-- Column Configuration Menu -->
  <mat-menu #configMenu="matMenu" xPosition="before" class="table-config-menu-panel">
    <div (click)="$event.stopPropagation()" class="config-menu-wrapper">
      <app-table-config-editor
        [options]="editorOptions"
        [tableColumnDefaultConfig]="{}"
        [hasLockOption]="true"
        [hasResponsiveOption]="false"
        (onTableColumnChangeEvent)="handleConfigChange($event)"
        (autoResizeChangeEvent)="handleAutoResize($event)">
      </app-table-config-editor>
    </div>
  </mat-menu>

  <!-- Table Footer with Actions and Paginator -->
  <div class="table-footer-container" *ngIf="config.features?.pagination !== false">
    <!-- Table Actions (left side) -->
    <div class="table-actions">
      <div class="button-group">
        <ng-content select="[tableActions]"></ng-content>
      </div>
    </div>

    <!-- Paginator (right side) -->
    <mat-paginator
      [length]="totalCount()"
      [pageSize]="config.defaultPageSize ?? 1000"
      [pageSizeOptions]="config.pageSizeOptions ?? [100, 200, 500, 1000, 2000, 5000]"
      [showFirstLastButtons]="true"
      (page)="onPageChangeEvent($event)">
    </mat-paginator>
  </div>
</div>
