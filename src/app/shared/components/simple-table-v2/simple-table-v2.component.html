<div class="simple-table-v2-container" 
     [class.loading]="loading()"
     [class.p-datatable-resizable]="resizableColumnsEnabled"
     [class.p-datatable-resizable-fit]="resizableColumnsEnabled && columnResizeMode === 'fit'"
     [class.p-datatable-resizable-expand]="resizableColumnsEnabled && columnResizeMode === 'expand'">
  
  <!-- Debug Info -->
  <div *ngIf="debug" style="background: #f0f0f0; padding: 10px; margin-bottom: 10px;">
    <strong>Debug Info:</strong><br>
    Rows in tableData: {{ tableData().length }}<br>
    Total Count: {{ totalCount() }}<br>
    Displayed Columns: {{ displayedColumns.join(', ') }}<br>
    Is Loading: {{ loading() }}<br>
    Data Source Type: {{ data ? data.constructor.name : 'undefined' }}<br>
    Resize Mode: {{ columnResizeMode }}<br>
    Is Resizing: {{ isResizing }}<br>
    Computed Height: {{ computedHeight }}px
  </div>

  <!-- Resize Helper Indicator (PrimeNG-style vertical line during resize) -->
  <div #resizeHelper class="p-datatable-column-resize-helper" style="display: none;"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading()">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <!-- Table (mat-table) when virtualScroll is off -->
  <div class="table-wrapper" [class.sticky-header]="config.stickyHeader" *ngIf="!config.features?.virtualScroll">
    <table 
      #tableElement
      mat-table 
      [dataSource]="tableData()" 
      matSort
      [matSortDisabled]="config.features?.sort === false"
      (matSortChange)="onSortChangeEvent($event)"
      class="simple-table-v2"
      [class.responsive]="config.responsive"
      [class.p-datatable-resizing]="isResizing">

      <!-- Selection Column -->
      <ng-container matColumnDef="select" *ngIf="selection && config.features?.selection !== false">
        <th mat-header-cell *matHeaderCellDef [class.sticky-column]="true" class="select-column">
          <mat-checkbox
            *ngIf="isMultipleSelection"
            (change)="$event ? masterToggle() : null"
            [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row" [class.sticky-column]="true" class="select-column">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? toggleSelection(row) : null"
            [checked]="selection.isSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Dynamic Columns -->
      <ng-container 
        *ngFor="let column of visibleColumns; trackBy: trackByColumnId" 
        [matColumnDef]="column.id">
        
        <!-- Header Cell (PrimeNG-style with resizable directive) -->
        <th 
          mat-header-cell 
          *matHeaderCellDef 
          [style.width]="getColWidthStyle(column.id)"
          [style.min-width]="getColWidthStyle(column.id)"
          [style.left]="(column.sticky === true || column.sticky === 'start') ? getColLeftStyle(column.id) : null"
          [mat-sort-header]="column.id"
          [disabled]="column.sortable === false || isResizing"
          [class.sticky-column]="column.sticky === true || column.sticky === 'start'"
          [class.sticky-column-end]="column.sticky === 'end'"
          [class.p-resizable-column]="resizableColumnsEnabled && column.resizable !== false"
          [attr.data-column]="column.id"
          pResizableColumn
          [pResizableColumnDisabled]="!resizableColumnsEnabled || column.resizable === false"
          (resizeBegin)="onColumnResizeBegin($event)"
          (resizeEnd)="onColumnResizeEnd($event)">
          
          <span class="header-label">
            {{ getColumnHeader(column) }}
          </span>
        </th>

        <!-- Body Cell -->
        <td 
          mat-cell 
          *matCellDef="let row" 
          [style.width]="getColWidthStyle(column.id)"
          [style.min-width]="getColWidthStyle(column.id)"
          [style.left]="(column.sticky === true || column.sticky === 'start') ? getColLeftStyle(column.id) : null"
          [class.sticky-column]="column.sticky === true || column.sticky === 'start'"
          [class.sticky-column-end]="column.sticky === 'end'"
          [attr.data-column]="column.id"
          [matTooltip]="column.tooltip ? getCellValue(row, column) : ''"
          [matTooltipDisabled]="!column.tooltip">
          
          <!-- Text/Default Cell -->
          <ng-container *ngIf="!column.type || column.type === 'text' || column.type === 'date' || column.type === 'number' || column.type === 'badge'">
            <span 
              class="cell-content" 
              [class.clamp]="column.clamp != null" 
              [style.--clamp-value]="column.clamp"
              [class.badge]="column.type === 'badge'">
              {{ getCellValue(row, column) }}
            </span>
          </ng-container>

          <!-- Link Cell -->
          <ng-container *ngIf="column.type === 'link'">
            <a 
              href="javascript:void(0)" 
              class="cell-link"
              [class.clamp]="column.clamp != null"
              [style.--clamp-value]="column.clamp"
              (click)="onHyperlinkClick($event, row, column.id)">
              {{ getCellValue(row, column) }}
            </a>
          </ng-container>

          <!-- Icon Cell -->
          <ng-container *ngIf="column.type === 'icon'">
            <mat-icon *ngIf="getCellValue(row, column) === true">check</mat-icon>
            <mat-icon *ngIf="getCellValue(row, column) === false">close</mat-icon>
            <span *ngIf="getCellValue(row, column) !== true && getCellValue(row, column) !== false" class="cell-content">
              {{ getCellValue(row, column) }}
            </span>
          </ng-container>

          <!-- Button Cell -->
          <ng-container *ngIf="column.type === 'button' && column.actions">
            <button 
              *ngFor="let action of column.actions"
              mat-icon-button 
              [matTooltip]="action.label || ''"
              (click)="onHyperlinkClick($event, row, action.handlerId)">
              <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
              <span *ngIf="!action.icon">{{ action.label }}</span>
            </button>
          </ng-container>

        </td>
      </ng-container>

      <!-- Config Button Column -->
      <ng-container matColumnDef="configButton">
        <th 
          mat-header-cell 
          *matHeaderCellDef 
          class="config-column"
          [class.sticky-column-end]="true">
          <button 
            mat-icon-button 
            [matMenuTriggerFor]="configMenu"
            matTooltip="{{ 'COMMON.CONFIGURE_COLUMNS' | translate }}">
            <mat-icon>more_vert</mat-icon>
          </button>
        </th>
        <td 
          mat-cell 
          *matCellDef="let row" 
          class="config-column"
          [class.sticky-column-end]="true">
        </td>
      </ng-container>

      <!-- Header Row -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: config.stickyHeader"></tr>

      <!-- Body Row -->
      <tr 
        mat-row 
        *matRowDef="let row; columns: displayedColumns; let i = index"
        (click)="onRowClick(row)"
        [class.clickable]="rowClick.observed"
        class="table-row"></tr>
    </table>
  </div>

  <!-- Virtual scroll grid (when config.features.virtualScroll is true) -->
  <div class="table-wrapper table-wrapper--virtual" [class.sticky-header]="config.stickyHeader" *ngIf="config.features?.virtualScroll">
    <div #gridTableElement class="grid-table" [class.p-datatable-resizing]="isResizing" role="grid" [attr.aria-label]="config.id || 'Table'">
      <!-- Header row -->
      <div class="grid-header-row" 
           [style.display]="'grid'"
           [style.grid-template-columns]="gridTemplateColumns()">
        <ng-container *ngIf="selection && config.features?.selection !== false">
          <div class="grid-header-cell grid-header-cell--select" role="columnheader">
            <mat-checkbox
              *ngIf="isMultipleSelection"
              (change)="$event ? masterToggle() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()">
            </mat-checkbox>
          </div>
        </ng-container>
        <div *ngFor="let column of visibleColumns; trackBy: trackByColumnId"
             class="grid-header-cell"
             role="columnheader"
             [attr.data-column]="column.id"
             [class.sticky-column]="column.sticky === true || column.sticky === 'start'"
             [style.left]="(column.sticky === true || column.sticky === 'start') ? getColLeftStyle(column.id) : null"
             [class.p-resizable-column]="resizableColumnsEnabled && column.resizable !== false"
             pResizableColumn
             [pResizableColumnDisabled]="!resizableColumnsEnabled || column.resizable === false"
             (resizeBegin)="onColumnResizeBegin($event)"
             (resizeEnd)="onColumnResizeEnd($event)"
             (click)="column.sortable !== false && !isResizing ? onVirtualSortHeaderClick(column.id) : null">
          <span class="header-label">{{ getColumnHeader(column) }}</span>
        </div>
        <ng-container *ngIf="showConfigEditor">
          <div class="grid-header-cell grid-header-cell--config" role="columnheader"></div>
        </ng-container>
      </div>
      <!-- Body: virtual viewport -->
      <cdk-virtual-scroll-viewport [itemSize]="virtualScrollItemSize" class="grid-viewport">
        <div *cdkVirtualFor="let row of tableData(); trackBy: trackByRow"
             class="grid-row table-row"
             [class.clickable]="rowClick.observed"
             (click)="onRowClick(row)"
             [style.display]="'grid'"
             [style.grid-template-columns]="gridTemplateColumns()"
             role="row">
          <ng-container *ngIf="selection && config.features?.selection !== false">
            <div class="grid-cell grid-cell--select" role="gridcell">
              <mat-checkbox
                (click)="$event.stopPropagation()"
                (change)="$event ? toggleSelection(row) : null"
                [checked]="selection.isSelected(row)">
              </mat-checkbox>
            </div>
          </ng-container>
          <div *ngFor="let column of visibleColumns; trackBy: trackByColumnId"
               class="grid-cell cell-content-wrapper"
               role="gridcell"
               [class.sticky-column]="column.sticky === true || column.sticky === 'start'"
               [style.left]="(column.sticky === true || column.sticky === 'start') ? getColLeftStyle(column.id) : null"
               [matTooltip]="column.tooltip ? getCellValue(row, column) : ''"
               [matTooltipDisabled]="!column.tooltip">
            <ng-container *ngIf="!column.type || column.type === 'text' || column.type === 'date' || column.type === 'number' || column.type === 'badge'">
              <span class="cell-content" [class.clamp]="column.clamp != null" [style.--clamp-value]="column.clamp" [class.badge]="column.type === 'badge'">{{ getCellValue(row, column) }}</span>
            </ng-container>
            <ng-container *ngIf="column.type === 'link'">
              <a href="javascript:void(0)" class="cell-link" [class.clamp]="column.clamp != null" [style.--clamp-value]="column.clamp" (click)="onHyperlinkClick($event, row, column.id)">{{ getCellValue(row, column) }}</a>
            </ng-container>
            <ng-container *ngIf="column.type === 'icon'">
              <mat-icon *ngIf="getCellValue(row, column) === true">check</mat-icon>
              <mat-icon *ngIf="getCellValue(row, column) === false">close</mat-icon>
              <span *ngIf="getCellValue(row, column) !== true && getCellValue(row, column) !== false" class="cell-content">{{ getCellValue(row, column) }}</span>
            </ng-container>
            <ng-container *ngIf="column.type === 'button' && column.actions">
              <button *ngFor="let action of column.actions" mat-icon-button [matTooltip]="action.label || ''" (click)="onHyperlinkClick($event, row, action.handlerId)">
                <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
                <span *ngIf="!action.icon">{{ action.label }}</span>
              </button>
            </ng-container>
          </div>
          <ng-container *ngIf="showConfigEditor">
            <div class="grid-cell grid-cell--config" role="gridcell"></div>
          </ng-container>
        </div>
      </cdk-virtual-scroll-viewport>
    </div>
  </div>

  <!-- Column Configuration Menu -->
  <mat-menu #configMenu="matMenu" xPosition="before" class="table-config-menu-panel">
    <div (click)="$event.stopPropagation()" class="config-menu-wrapper">
      <app-table-config-editor
        [options]="editorOptions"
        [tableColumnDefaultConfig]="{}"
        [hasLockOption]="true"
        [hasResponsiveOption]="false"
        (onTableColumnChangeEvent)="handleConfigChange($event)"
        (autoResizeChangeEvent)="handleAutoResize($event)">
      </app-table-config-editor>
    </div>
  </mat-menu>

  <!-- Table Footer with Actions and Paginator -->
  <div class="table-footer-container" *ngIf="config.features?.pagination !== false">
    <!-- Table Actions (left side) -->
    <div class="table-actions">
      <div class="button-group">
        <ng-content select="[tableActions]"></ng-content>
      </div>
    </div>

    <!-- Paginator (right side) -->
    <mat-paginator
      [length]="totalCount()"
      [pageSize]="config.defaultPageSize ?? 1000"
      [pageSizeOptions]="config.pageSizeOptions ?? [100, 200, 500, 1000, 2000, 5000]"
      [showFirstLastButtons]="true"
      (page)="onPageChangeEvent($event)">
    </mat-paginator>
  </div>
</div>
